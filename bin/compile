#!/usr/bin/env bash

set -e

build_dir="$1"
cache_dir="$2"
dest_dir="/app/vendor"

lpsolve_build_dir="$build_dir/lpsolve"
lpsolve_cache_dir="$cache_dir/lpsolve"
lpsolve_dest_dir="$dest_dir/lpsolve"

VERSION="5.5.0.10i"

status() {
  echo "-----> $*"
}

mkdir -p $lpsolve_cache_dir/bin
mkdir -p $lpsolve_dest_dir

if [[ -f $lpsolve_cache_dir/bin/lp_solve ]]; then
  status "Installing lpsolve $VERSION"
  cp -R $lpsolve_cache_dir/* $lpsolve_dest_dir
else
  status "Downloading and installing lpsolve $VERSION"
  curl 'http://bashdb.sourceforge.net/lpsolve-5.5.0.10i.tar.bz2' -o - | tar xjf - -C $lpsolve_build_dir
  cd $lpsolve_build_dir/lpsolve-5.5.0.10i
  ./configure --prefix=$lpsolve_dest_dir && make && make check && make install
fi

status "Building runtime environment"
mkdir -p $build_dir/.profile.d
echo "export PATH=\"$lpsolve_dest_dir/bin:\$PATH\"" >> $build_dir/.profile.d/lpsolve.sh
echo "export LDFLAGS=\"$lpsolve_dest_dir/lib\"" >> $build_dir/.profile.d/lpsolve.sh
echo "export CFLAGS=\"$lpsolve_dest_dir/include\"" >> $build_dir/.profile.d/lpsolve.sh
